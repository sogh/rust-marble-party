# Session Log - 2026-01-20

## User Request
Fix marble falling out of spiral tube when using `--track spiral,spiral` configuration.

## Problem Analysis
The marble was falling through the spiral tube geometry due to incorrect SDF boundary checking. Investigation revealed:

1. **Wrong segment claiming points**: The second spiral's SDF was accepting points that belonged to the first spiral because the entry direction dot-product check wasn't suitable for spiral geometry (the entry direction points downward, not horizontally).

2. **Large penetration values**: The marble showed penetration values of 6.7+ when it should be ~0.02, because the wrong segment's spine was being used for distance calculations.

3. **Stuck at transition**: After fixing the first issue, the marble would get stuck at the spiral-to-spiral transition because the first spiral was still claiming points below its exit.

## Solution
Updated `src/track/segments/spiral_tube.rs` with improved boundary checking:

1. **Y-range based boundary**: Instead of using entry direction dot product (which doesn't work well for downward-pointing entries), use a simple Y-range check:
   ```rust
   let margin = self.tube_radius * 1.0;
   let max_y = entry_y + margin;
   let min_y = exit_y - margin;
   if point.y > max_y || point.y < min_y {
       return f32::MAX;
   }
   ```

2. **Exit direction check**: Added explicit check for points past the exit:
   ```rust
   if closest_segment_idx == last_segment_idx && closest_t > 0.9 {
       let along_exit = to_point_exit.dot(self.exit.direction);
       if along_exit > OVERLAP_DISTANCE {
           return f32::MAX;
       }
   }
   ```

3. **Reduced overlap distance**: Changed from 1.0 to 0.3 to prevent adjacent spirals from both claiming the same points.

## Key Changes
- `src/track/segments/spiral_tube.rs`:
  - Entry boundary: Y-range check instead of direction dot product
  - Exit boundary: Check if closest point is at spine end and point is past exit
  - OVERLAP_DISTANCE reduced from 1.0 to 0.3

## Testing
Verified with `--track spiral,spiral` - marble now successfully:
- Enters first spiral
- Rolls through first spiral with proper collision (pen ~0.015)
- Transitions to second spiral at y=3.4
- Rolls through second spiral
- Exits to next segment (or falls if no next segment)

---

## Second Fix: FinishLine floor alignment

### Problem
The FinishLine segment was using `entry_port.position.y` as the floor level, but when coming from ReverseTubeAdapter, the port position is at the segment axis (center), not the floor. The actual floor level is stored in the port's FlatFloor profile.

### Solution
Updated `src/track/segments/finish_line.rs` to extract floor_y from the incoming port's profile:

```rust
let entry_floor_y = match &entry_port.profile {
    PortProfile::FlatFloor { floor_y, .. } => *floor_y,
    _ => entry_port.position.y,
};
```

Also updated:
- Entry position placed at floor level
- End position calculated from floor level
- Corner calculations use floor-level entry position

### Testing
Verified with `--track spiral,spiral,finishline`:
- Marble transitions through all 6 segments correctly
- Floor collision on FinishLine works properly (pen ~0.020, normal pointing up)
- Marble rolls to a stop on the finish line
